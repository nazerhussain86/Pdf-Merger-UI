<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PDF Merger UI</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    #dropZone.shadow { box-shadow: 0 0 20px #87b5ff; }
    #pdfPreview { background: #fafbfc; }
    .active { background: #e7f1ff !important; }
  </style>
</head>
<body>
<div class="container py-4">
  <h2 class="mb-4">PDF Merger</h2>
  <div class="row">
    <div class="col-md-6">
      <div id="dropZone" class="border border-primary rounded bg-light p-5 text-center mb-3" style="min-height:150px; cursor:pointer;">
        <div id="dropZoneText">
          Drag &amp; drop PDFs here or <span class="text-primary">click to select</span>
        </div>
        <input type="file" multiple accept="application/pdf" class="d-none" id="fileInput">
      </div>
      <ul id="fileList" class="list-group mb-3" style="min-height:50px;"></ul>
      <button id="addBtn" class="btn btn-outline-secondary" type="button">Add PDF</button>
      <button id="mergeBtn" class="btn btn-primary ms-2" type="button" disabled>Merge PDFs</button>
    </div>
    <div class="col-md-6">
      <div class="border rounded p-3 bg-white" style="min-height:400px;">
        <h5 id="previewTitle" class="mb-3">Preview</h5>
        <canvas id="pdfPreview" style="width:100%; border:1px solid #dee2e6; display:none;"></canvas>
        <div id="noPreview" class="text-muted">Select a file to preview</div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>

<script>
const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');
const fileList = document.getElementById('fileList');
const pdfPreview = document.getElementById('pdfPreview');
const noPreview = document.getElementById('noPreview');
const addBtn = document.getElementById('addBtn');
const mergeBtn = document.getElementById('mergeBtn');

let files = [];
let selectedIdx = null;

// Drag and drop and click to upload
dropZone.onclick = () => fileInput.click();
addBtn.onclick = () => fileInput.click();

dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('shadow'); };
dropZone.ondragleave = () => dropZone.classList.remove('shadow');
dropZone.ondrop = (e) => {
  e.preventDefault();
  dropZone.classList.remove('shadow');
  handleFiles(e.dataTransfer.files);
};
fileInput.onchange = () => handleFiles(fileInput.files);

// Add files to list (skip duplicates by name)
function handleFiles(fileListObj) {
  Array.from(fileListObj).forEach(f => {
    if (f.type === "application/pdf" && !files.some(existing => existing.name === f.name)) {
      files.push(f);
    }
  });
  updateFileList();
}

// Render the list of uploaded files, with active selection and remove button
function updateFileList() {
  fileList.innerHTML = "";
  files.forEach((file, idx) => {
    const li = document.createElement('li');
    li.className = "list-group-item d-flex justify-content-between align-items-center" + (idx === selectedIdx ? " active" : "");
    li.textContent = file.name;
    li.style.cursor = "pointer";
    li.onclick = () => { selectedIdx = idx; showPreview(file); updateFileList(); };
    const btn = document.createElement('button');
    btn.className = "btn-close";
    btn.onclick = (e) => { 
      e.stopPropagation(); 
      files.splice(idx, 1); 
      if(selectedIdx === idx) selectedIdx = null;
      else if(selectedIdx && selectedIdx > idx) selectedIdx--;
      updateFileList(); 
      clearPreview(); 
    };
    li.appendChild(btn);
    fileList.appendChild(li);
  });
  mergeBtn.disabled = files.length < 2;
  // If user removed the active file, clear preview.
  if (selectedIdx === null || !files[selectedIdx]) clearPreview();
}

// On file select: render PDF first page as preview using PDF.js
function showPreview(file) {
  noPreview.style.display = "none";
  pdfPreview.style.display = "block";
  const reader = new FileReader();
  reader.onload = function(e) {
    pdfjsLib.getDocument({ data: e.target.result }).promise.then(pdf => {
      pdf.getPage(1).then(page => {
        const viewport = page.getViewport({ scale: 1.5 });
        pdfPreview.height = viewport.height;
        pdfPreview.width = viewport.width;
        const ctx = pdfPreview.getContext('2d');
        ctx.clearRect(0, 0, pdfPreview.width, pdfPreview.height);
        page.render({ canvasContext: ctx, viewport: viewport });
      });
    });
  };
  reader.readAsArrayBuffer(file);
}

// Default preview panel when nothing selected
function clearPreview() {
  pdfPreview.style.display = "none";
  noPreview.style.display = "block";
}

// Button actions (to be implemented)
mergeBtn.onclick = function() {
  alert("PDF merging is not implemented in this UI demo.");
}
function updateFileList() {
  fileList.innerHTML = "";
  files.forEach((file, idx) => {
    const li = document.createElement('li');
    li.className = "list-group-item d-flex justify-content-between align-items-center" + (idx === selectedIdx ? " active" : "");
    li.style.cursor = "pointer";
    li.onclick = () => { selectedIdx = idx; showPreview(file); updateFileList(); };

    // File name label, taking available width
    const nameDiv = document.createElement('span');
    nameDiv.textContent = file.name;
    nameDiv.style.flex = "1";
    li.appendChild(nameDiv);

    // Move up button
    const upBtn = document.createElement('button');
    upBtn.className = "btn btn-sm btn-outline-secondary me-1";
    upBtn.style.fontSize = '0.9em';
    upBtn.title = "Move up";
    upBtn.innerHTML = "&#8593;";
    upBtn.onclick = (e) => {
      e.stopPropagation();
      if(idx > 0) {
        [files[idx-1], files[idx]] = [files[idx], files[idx-1]];
        if (selectedIdx === idx) selectedIdx = idx-1;
        else if (selectedIdx === idx-1) selectedIdx = idx;
        updateFileList();
      }
    };
    upBtn.disabled = idx === 0;
    li.appendChild(upBtn);

    // Move down button
    const downBtn = document.createElement('button');
    downBtn.className = "btn btn-sm btn-outline-secondary me-1";
    downBtn.style.fontSize = '0.9em';
    downBtn.title = "Move down";
    downBtn.innerHTML = "&#8595;";
    downBtn.onclick = (e) => {
      e.stopPropagation();
      if(idx < files.length - 1) {
        [files[idx+1], files[idx]] = [files[idx], files[idx+1]];
        if (selectedIdx === idx) selectedIdx = idx+1;
        else if (selectedIdx === idx+1) selectedIdx = idx;
        updateFileList();
      }
    };
    downBtn.disabled = idx === files.length - 1;
    li.appendChild(downBtn);

    // Close (delete) button
    const btn = document.createElement('button');
    btn.className = "btn-close";
    btn.onclick = (e) => { 
      e.stopPropagation(); 
      files.splice(idx, 1); 
      if(selectedIdx === idx) selectedIdx = null;
      else if(selectedIdx && selectedIdx > idx) selectedIdx--;
      updateFileList(); 
      clearPreview(); 
    };
    li.appendChild(btn);

    fileList.appendChild(li);
  });
  mergeBtn.disabled = files.length < 2;
  // If user removed the active file, clear preview.
  if (selectedIdx === null || !files[selectedIdx]) clearPreview();

mergeBtn.onclick = async function() {
  if (files.length < 2) {
    alert("Please select at least two PDFs to merge.");
    return;
  }
  // Read all PDFs as ArrayBuffers
  const pdfBuffers = await Promise.all(files.map(f => f.arrayBuffer()));

  // Create a new PDFDocument
  const mergedPdf = await PDFLib.PDFDocument.create();

  for(let ab of pdfBuffers) {
    const pdf = await PDFLib.PDFDocument.load(ab);
    const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
    copiedPages.forEach(page => mergedPdf.addPage(page));
  }

  // Serialize the merged PDF to bytes (Uint8Array)
  const mergedPdfBytes = await mergedPdf.save();

  // Trigger browser download
  const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'merged.pdf';
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }, 100);
};

}

</script>
</body>
</html>
